{"version":3,"file":"22.9ff674b2.js","sources":["../../../../../../src/routes/invite/s/[hash]/+page.svelte"],"sourcesContent":["<script lang=\"ts\">\n  import { goto } from '$app/navigation';\n  import { onMount } from 'svelte';\n  import PrimaryButton from '$lib/components/PrimaryButton/index.svelte';\n  import { getSupabase } from '$lib/utils/functions/supabase';\n  import AuthUI from '$lib/components/AuthUI/index.svelte';\n  import { currentOrg } from '$lib/utils/store/org';\n  import { setTheme } from '$lib/utils/functions/theme';\n  import { addGroupMember } from '$lib/utils/services/courses';\n  import type { CurrentOrg } from '$lib/utils/types/org.js';\n  import { ROLE } from '$lib/utils/constants/roles';\n  import { profile } from '$lib/utils/store/user';\n  import {\n    triggerSendEmail,\n    NOTIFICATION_NAME\n  } from '$lib/utils/services/notification/notification';\n  import { snackbar } from '$lib/components/Snackbar/store.js';\n  import { capturePosthogEvent } from '$lib/utils/services/posthog';\n  import { page } from '$app/stores';\n\n  export let data;\n\n  let supabase = getSupabase();\n  let loading = false;\n\n  let disableSubmit = false;\n  let formRef: HTMLFormElement;\n\n  async function handleSubmit() {\n    loading = true;\n\n    if (!$profile.id || !$profile.email) {\n      console.log('Profile not found', $profile);\n      return goto(`/signup?redirect=${$page.url?.pathname || ''}`);\n    }\n\n    const { data: courseData, error } = await supabase\n      .from('course')\n      .select('group_id')\n      .eq('id', data.id)\n      .single();\n\n    console.log({ courseData });\n    if (!courseData?.group_id) {\n      console.error('error getting group', error);\n      return;\n    }\n\n    const member = {\n      profile_id: $profile.id,\n      group_id: courseData.group_id,\n      role_id: ROLE.STUDENT\n    };\n\n    const teacherMembers = await supabase\n      .from('groupmember')\n      .select('id, profile(email)')\n      .eq('group_id', courseData.group_id)\n      .eq('role_id', ROLE.TUTOR)\n      .returns<\n        {\n          id: string;\n          profile: {\n            email: string;\n          };\n        }[]\n      >();\n\n    const teachers: Array<string> =\n      teacherMembers.data?.map((teacher) => {\n        return teacher.profile?.email || '';\n      }) || [];\n\n    addGroupMember(member).then((addedMember) => {\n      loading = false;\n      if (addedMember.error) {\n        console.error('Error adding student to group', courseData.group_id, addedMember.error);\n        snackbar.error('snackbar.invite.failed_join');\n\n        // Full page load to lms if error joining, probably user already joined\n        window.location.href = '/lms';\n        return;\n      }\n\n      capturePosthogEvent('student_joined_course', {\n        course_name: data.name,\n        student_id: $profile.id,\n        student_email: $profile.email\n      });\n\n      // Send email welcoming student to the course\n      // triggerSendEmail(NOTIFICATION_NAME.STUDENT_COURSE_WELCOME, {\n      //   to: $profile.email,\n      //   orgName: data.currentOrg?.name,\n      //   courseName: data.name\n      // });\n\n      // Send notification to all teacher(s) that a student has joined the course.\n      // Promise.all(\n      //   teachers.map((email) =>\n      //     triggerSendEmail(NOTIFICATION_NAME.TEACHER_STUDENT_JOINED, {\n      //       to: email,\n      //       courseName: data.name,\n      //       studentName: $profile.fullname,\n      //       studentEmail: $profile.email\n      //     })\n      //   )\n      // );\n\n      // go to lms\n      return goto('/lms');\n    });\n  }\n\n  function setCurOrg(cOrg: CurrentOrg) {\n    if (!cOrg) return;\n    currentOrg.set(cOrg);\n  }\n\n  onMount(async () => {\n    setTheme(data.currentOrg?.theme || '');\n  });\n\n  $: setCurOrg(data.currentOrg as CurrentOrg);\n</script>\n\n<svelte:head>\n  <title>Join {data.name} on KinetsHub</title>\n</svelte:head>\n\n<AuthUI\n  {supabase}\n  isLogin={false}\n  {handleSubmit}\n  isLoading={loading}\n  showOnlyContent={true}\n  showLogo={true}\n  bind:formRef\n>\n  <div class=\"mt-0 w-full\">\n    <h3 class=\"dark:text-white text-lg font-medium mt-0 mb-4 text-center\">{data.name}</h3>\n    <p class=\"dark:text-white text-sm font-light text-center\">{data.description}</p>\n  </div>\n\n  <div class=\"my-4 w-full flex justify-center items-center\">\n    <PrimaryButton\n      label=\"Join Course\"\n      type=\"submit\"\n      isDisabled={disableSubmit || loading}\n      isLoading={loading}\n    />\n  </div>\n</AuthUI>\n"],"names":["t0_value","ctx","t2_value","current","dirty","set_data","t0","t2","primarybutton_changes","title_value","data","$$props","formRef","handleSubmit","$profile","courseData","error","supabase","member","ROLE","_a","teacher","addedMember","snackbar","goto","cOrg","currentOrg","onMount"],"mappings":"moCA4I2EA,EAAAC,EAAA,CAAA,EAAA,KAAA,SACZC,EAAAD,EAAA,CAAA,EAAA,YAAA,sEAO7C,WAAAA,EAAA,CAAA,wrBARyD,CAAAE,GAAAC,EAAA,IAAAJ,KAAAA,EAAAC,EAAA,CAAA,EAAA,KAAA,KAAAI,EAAAC,EAAAN,CAAA,GACZ,CAAAG,GAAAC,EAAA,IAAAF,KAAAA,EAAAD,EAAA,CAAA,EAAA,YAAA,KAAAI,EAAAE,EAAAL,CAAA,aAO7CE,EAAA,IAAAI,EAAA,WAAAP,EAAA,CAAA,oKArBH,SAAA,MAAAQ,EAAA,QAAAR,EAAA,CAAA,EAAA,KAAA,wZAAA,CAAAE,GAAAC,EAAA,IAAAK,KAAAA,EAAA,QAAAR,EAAA,CAAA,EAAA,KAAA,2TA3GF,GAAA,CAAA,KAAAS,CAAA,EAAAC,aAMPC,EAEW,eAAAC,GAAA,SAGR,aAAA,CAAAC,EAAA,IAAA,CAAAA,EAAA,iHAKG,KAAA,CAAA,KAAAC,EAAA,MAAAC,CAAA,EAAA,MAAAC,EAAA,KAAA,QAAA,EAAA,OAAA,UAAA,EAAA,GAAA,KAAAP,EAAA,EAAA,EAAA,OAAA,KAMR,QAAA,IAAA,CAAA,WAAAK,CAAA,CAAA,wEAMM,MAAAG,EAAA,CACJ,WAAAJ,EAAA,GACA,SAAAC,EAAA,SACA,QAAAI,EAAA,aAGI,MAAAF,EAAA,KAAA,aAAA,EAAA,OAAA,oBAAA,EAAA,GAAA,WAAAF,EAAA,QAAA,EAAA,GAAA,UAAAI,EAAA,KAAA,EAAA,QAAA,gCAgBK,QAAAC,EAAAC,EAAA,UAAA,YAAAD,EAAA,QAAA,0CAMP,QAAA,MAAA,gCAAAL,EAAA,SAAAO,EAAA,KAAA,EACAC,GAAA,MAAA,6BAAA,EAGA,OAAA,SAAA,KAAA,iDAKA,YAAAb,EAAA,KACA,WAAAI,EAAA,GACA,cAAAA,EAAA,QAuBKU,EAAA,MAAA,kBAKJC,GACLC,EAAA,IAAAD,CAAA,EAGFE,EAAA,SAAA"}