{"version":3,"file":"_server-f2809699.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/lmz/webhook/_server.js"],"sourcesContent":[";\n!function() {\n  try {\n    var e = \"undefined\" != typeof window ? window : \"undefined\" != typeof global ? global : \"undefined\" != typeof self ? self : {}, n = new Error().stack;\n    n && (e._sentryDebugIds = e._sentryDebugIds || {}, e._sentryDebugIds[n] = \"71b88174-23d1-4cdc-9ec3-d0bc1e79e511\", e._sentryDebugIdIdentifier = \"sentry-dbid-71b88174-23d1-4cdc-9ec3-d0bc1e79e511\");\n  } catch (e2) {\n  }\n}();\nimport { j as json } from \"../../../../../chunks/index.js\";\nimport crypto from \"crypto\";\nimport { b as private_env } from \"../../../../../chunks/shared-server.js\";\nimport { c as createOrgPlan, a as cancelOrgPlan } from \"../../../../../chunks/index6.js\";\nimport { P as PLAN } from \"../../../../../chunks/org.js\";\nimport { g as getServerSupabase } from \"../../../../../chunks/supabase.server.js\";\nimport \"../../../../../chunks/_sentry-release-injection-file.js\";\nasync function POST({ request }) {\n  try {\n    const supabase = getServerSupabase();\n    const clonedReq = request.clone();\n    const eventType = request.headers.get(\"X-Event-Name\");\n    const body = await request.json();\n    const secret = private_env.LEMON_SQUEEZY_WEBHOOK_SECRET;\n    const hmac = crypto.createHmac(\"sha256\", secret);\n    const digest = Buffer.from(hmac.update(await clonedReq.text()).digest(\"hex\"), \"utf8\");\n    const signature = Buffer.from(request.headers.get(\"X-Signature\") || \"\", \"utf8\");\n    if (!crypto.timingSafeEqual(digest, signature)) {\n      throw new Error(\"Invalid signature.\");\n    }\n    console.log(body);\n    if (eventType === \"subscription_created\" || eventType === \"subscription_resumed\") {\n      const orgId = body.meta.custom_data.org_id;\n      const triggeredBy = body.meta.custom_data.triggered_by;\n      const isSuccessful = body.data.attributes.status === \"active\";\n      console.log({\n        orgId,\n        triggeredBy,\n        isSuccessful\n      });\n      if (isSuccessful && orgId) {\n        const { data, error } = await createOrgPlan({\n          supabase,\n          orgId,\n          triggeredBy: parseInt(triggeredBy),\n          planName: PLAN.EARLY_ADOPTER,\n          data: body.data\n        });\n        if (error)\n          console.error(\"Error creating org plan\", error);\n        console.log(\"Create plan\", data);\n      }\n    }\n    if ([\"subscription_cancelled\", \"subscription_expired\", \"subscription_payment_refunded\"].includes(\n      `${eventType}`\n    )) {\n      const orgId = body.meta.custom_data.org_id;\n      const { data, error } = await cancelOrgPlan({\n        orgId,\n        planName: PLAN.EARLY_ADOPTER\n      });\n      if (error)\n        console.error(\"Error canceling org plan\", error);\n      console.log(\"Cancel plan\", data);\n    }\n    return json({ message: \"Webhook received\" });\n  } catch (err) {\n    console.error(err);\n    return json({ message: \"Server error\" }, { status: 500 });\n  }\n}\nfunction GET() {\n  return json({\n    success: true\n  });\n}\nexport {\n  GET,\n  POST\n};\n//# sourceMappingURL=_server.js.map\n"],"names":[],"mappings":"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"}