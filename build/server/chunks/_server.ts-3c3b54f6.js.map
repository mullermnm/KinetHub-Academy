{"version":3,"file":"_server.ts-3c3b54f6.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/email/course/newsfeed/_server.ts.js"],"sourcesContent":[";\n!function() {\n  try {\n    var e = \"undefined\" != typeof window ? window : \"undefined\" != typeof global ? global : \"undefined\" != typeof self ? self : {}, n = new Error().stack;\n    n && (e._sentryDebugIds = e._sentryDebugIds || {}, e._sentryDebugIds[n] = \"46e27c5a-27b5-4b30-954e-26c6c16ab4bd\", e._sentryDebugIdIdentifier = \"sentry-dbid-46e27c5a-27b5-4b30-954e-26c6c16ab4bd\");\n  } catch (e2) {\n  }\n}();\nimport { j as json } from \"../../../../../../chunks/index.js\";\nimport { g as getServerSupabase } from \"../../../../../../chunks/supabase.server.js\";\nimport { g as getFeedForNotification } from \"../../../../../../chunks/index4.js\";\nimport { s as sendEmail } from \"../../../../../../chunks/sendEmail.js\";\nimport \"../../../../../../chunks/_sentry-release-injection-file.js\";\nconst supabase = getServerSupabase();\nconst sendEmailNotification = async (feedId, authorId, comment) => {\n  const feed = await getFeedForNotification({\n    supabase,\n    feedId,\n    authorId\n  });\n  console.log({ feed });\n  if (!feed)\n    return;\n  const postLink = `https://${feed.org.siteName}.KinetsHub.com/courses/${feed.courseId}?feedId=${feed.id}`;\n  if (comment) {\n    const emailData = [\n      {\n        from: `\"${feed.org.name} - KinetsHub\" <notify@mail.classroomio.com>`,\n        to: feed.teacherEmail,\n        subject: `[${feed.courseTitle}] - News feed comment`,\n        content: `\n      <p>A student left you a comment on your newsfeed post</p>\n\n      <div style=\"font-style: italic; margin-top: 10px;\">${comment}</div>\n      <div>\n        <a class=\"button\" href=\"${postLink}\">View comment</a>\n      </div>\n      `,\n        replyTo: \"noreply@classroomio.com\"\n      }\n    ];\n    await sendEmail(emailData);\n    return;\n  }\n  if (!feed.courseMembers.length) {\n    return;\n  }\n  const emailsData = feed.courseMembers.map((member) => ({\n    from: `\"${feed.org.name} - ClassroomIO\" <notify@mail.classroomio.com>`,\n    to: member.email,\n    replyTo: feed.teacherEmail,\n    subject: `[${feed.courseTitle}] - New post in course`,\n    content: `\n    <p>${feed.teacherName} made a post in a course you are taking: ${feed.courseTitle}.</p>\n\n    <div style=\"font-style: italic; margin-top: 10px;\">${feed.content}</div>\n    <div>\n      <a class=\"button\" href=\"${postLink}\">View post</a>\n    </div>\n    `\n  }));\n  console.log(\"Sending emails to all students\", feed.courseMembers.length);\n  await sendEmail(emailsData);\n};\nasync function POST({ request }) {\n  const { authorId, feedId, comment } = await request.json();\n  const accessToken = request.headers.get(\"Authorization\") || \"\";\n  console.log(\"/POST api/email/course/newsfeed\");\n  if (!authorId || !feedId || !accessToken) {\n    return json({ success: false, message: \"Missing required fields\" }, { status: 400 });\n  }\n  let user;\n  try {\n    const { data } = await supabase.auth.getUser(accessToken);\n    user = data.user;\n  } catch (error) {\n    console.error(error);\n  }\n  if (!user) {\n    return json({ success: false, message: \"Unauthenticated user\" }, { status: 401 });\n  }\n  await sendEmailNotification(feedId, authorId, comment);\n  return json({\n    success: true,\n    message: \"Email sent\"\n  });\n}\nexport {\n  POST\n};\n//# sourceMappingURL=_server.ts.js.map\n"],"names":[],"mappings":"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"}